<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Tektime Assistant</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    body {
      font-family: "Segoe UI", sans-serif;
      background: #f0f2f5;
      display: flex;
      flex-direction: column;
      height: 100dvh; /* dynamic viewport height — fondamentale su mobile */
    }

    header {
      width: 100%;
      background: #1a1a2e;
      color: white;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      flex-shrink: 0;
    }

    header h1 {
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 12px;
      gap: 10px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 16px;
      line-height: 1.6;
      font-size: 0.92rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      animation: fadeIn 0.2s ease;
    }

    @media (min-width: 600px) {
      .message { max-width: 75%; font-size: 0.95rem; }
      #chat-container { padding: 20px 16px; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .user-message {
      background: #1a1a2e;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .bot-message {
      background: white;
      color: #1a1a2e;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .bot-message.streaming::after {
      content: "\25AE";
      animation: blink 0.7s infinite;
      color: #1a1a2e;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0; }
    }

    .error-message {
      background: #ffe0e0;
      color: #c0392b;
      align-self: center;
      border-radius: 12px;
      font-size: 0.85rem;
      max-width: 90%;
      padding: 10px 14px;
    }

    .typing-indicator {
      display: flex;
      gap: 5px;
      padding: 12px 16px;
      background: white;
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      align-self: flex-start;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    .typing-indicator span {
      width: 8px; height: 8px;
      background: #999;
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30%            { transform: translateY(-6px); }
    }

    #input-area {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      background: white;
      border-top: 1px solid #e0e0e0;
      flex-shrink: 0;
      /* evita che la tastiera mobile nasconda la casella */
      padding-bottom: max(10px, env(safe-area-inset-bottom));
    }

    #user-input {
      flex: 1;
      padding: 10px 14px;
      border: 1.5px solid #ddd;
      border-radius: 24px;
      font-size: 1rem; /* minimo 16px su iOS evita lo zoom automatico */
      outline: none;
      resize: none;
      max-height: 100px;
      min-height: 42px;
      transition: border 0.2s;
      font-family: inherit;
      line-height: 1.4;
    }

    #user-input:focus { border-color: #1a1a2e; }

    #send-btn {
      background: #1a1a2e;
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      min-width: 44px;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.1s;
      flex-shrink: 0;
      align-self: flex-end;
    }

    #send-btn:hover  { background: #16213e; }
    #send-btn:active { transform: scale(0.93); }
    #send-btn:disabled { background: #aaa; cursor: not-allowed; }

    .welcome {
      text-align: center;
      color: #888;
      margin: auto;
      padding: 30px 16px;
    }

    .welcome h2 { font-size: 1.2rem; color: #1a1a2e; margin-bottom: 10px; }
    .welcome p  { font-size: 0.88rem; line-height: 1.8; }
    #disclaimer {
      width: 100%;
      max-width: 800px;
      padding: 6px 16px 8px;
      font-size: 0.72rem;
      color: #999;
      line-height: 0.9em;
      text-align: center;
      background: #f0f2f5;
      flex-shrink: 0;
    }

    #disclaimer a {
      color: #999;
      text-decoration: underline;
    }

  </style>
</head>
<body>

<header>
  <h1>&#128105; Tektime AI Assistant</h1>
</header>

<div id="chat-container">
  <div class="welcome">
    <h2>Welcome to Tektime AI Assistant</h2>
    <p>
      Ask me anything about Tektime services.<br/>
      <i>Puedes preguntar en cualquier idioma.</i><br/>
      Puoi fare domande in qualsiasi lingua.
    </p>
  </div>
</div>

<div id="input-area">
  <textarea id="user-input" rows="1" placeholder="Ask / Scrivi..."></textarea>
  <button id="send-btn" title="Send">&#9658;</button>
</div>

<div id="disclaimer">
  The information provided through this AI assistant is for general informational purposes only and may not always be accurate, complete, or up to date. It should not be considered official, contractual, or legally binding. For precise information or specific inquiries, please contact us directly at <a href="mailto:info@tektime.it">info@tektime.it</a>.
</div>

<script>
  const chatContainer = document.getElementById("chat-container");
  const userInput     = document.getElementById("user-input");
  const sendBtn       = document.getElementById("send-btn");

  let documentContent     = "";
  let conversationHistory = [];
  let welcomeRemoved      = false;

  // Su mobile, quando si apre la tastiera il viewport cambia:
  // scorriamo in basso per tenere visibile l ultima risposta
  if (typeof visualViewport !== "undefined") {
    visualViewport.addEventListener("resize", () => {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    });
  }

  async function loadDocument() {
    try {
      const res = await fetch("./documento.txt");
      if (!res.ok) throw new Error("status " + res.status);
      documentContent = await res.text();
    } catch (e) {
      addMessage("Documento non trovato. Controlla che documento.txt sia nella root del repository.", "error");
    }
  }

  function removeWelcome() {
    if (!welcomeRemoved) {
      const w = chatContainer.querySelector(".welcome");
      if (w) w.remove();
      welcomeRemoved = true;
    }
  }

  function addMessage(text, type) {
    removeWelcome();
    const div = document.createElement("div");
    div.className = "message " + type + "-message";
    div.textContent = text;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return div;
  }

  function showTyping() {
    removeWelcome();
    const div = document.createElement("div");
    div.className = "typing-indicator";
    div.id = "typing";
    div.innerHTML = "<span></span><span></span><span></span>";
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function removeTyping() {
    const t = document.getElementById("typing");
    if (t) t.remove();
  }

  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;

    if (!documentContent) {
      addMessage("Il documento non e ancora caricato. Attendi o ricarica la pagina.", "error");
      return;
    }

    addMessage(text, "user");
    userInput.value = "";
    userInput.style.height = "auto";
    sendBtn.disabled = true;
    showTyping();

    // Nascondi tastiera su mobile dopo invio
    userInput.blur();

    const systemPrompt = `You are Tektime Assistant, the official virtual assistant for Tektime — a publishing services company specializing in book translation, audiobook narration, and self-publishing in 78 languages.

RULES:
1. Answer ONLY using the information contained in the document below. Do not use any external knowledge but read carefully the document and extract the right information for your answer.
2. Always reply in the SAME LANGUAGE the user used to write their question (auto-detect language).
3. If the answer is not found in the document, politely say you do not have that information and invite the user to contact Tektime directly.
4. Be friendly, professional, and concise.

=== TEKTIME DOCUMENT START ===
${documentContent}
=== TEKTIME DOCUMENT END ===`;

    const messages = [
      { role: "system", content: systemPrompt },
      ...conversationHistory,
      { role: "user", content: text }
    ];

    try {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Errore server (" + res.status + ")");
      }

      removeTyping();

      const botDiv = addMessage("", "bot");
      botDiv.classList.add("streaming");

      const reader  = res.body.getReader();
      const decoder = new TextDecoder();
      let fullReply = "";
      let buffer    = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n");
        buffer = lines.pop();

        for (const line of lines) {
          if (!line.startsWith("data: ")) continue;
          const data = line.slice(6).trim();
          if (data === "[DONE]") continue;
          try {
            const json  = JSON.parse(data);
            const token = json.choices?.[0]?.delta?.content || "";
            if (token) {
              fullReply += token;
              botDiv.textContent = fullReply;
              chatContainer.scrollTop = chatContainer.scrollHeight;
            }
          } catch (_) {}
        }
      }

      botDiv.classList.remove("streaming");

      if (fullReply) {
        conversationHistory.push({ role: "user",      content: text      });
        conversationHistory.push({ role: "assistant", content: fullReply });
        if (conversationHistory.length > 20) {
          conversationHistory = conversationHistory.slice(-20);
        }
      }

    } catch (e) {
      removeTyping();
      addMessage("Errore: " + e.message, "error");
    } finally {
      sendBtn.disabled = false;
    }
  }

  userInput.addEventListener("input", () => {
    userInput.style.height = "auto";
    userInput.style.height = Math.min(userInput.scrollHeight, 100) + "px";
  });

  userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  sendBtn.addEventListener("click", sendMessage);
  loadDocument();
</script>

</body>
</html>
